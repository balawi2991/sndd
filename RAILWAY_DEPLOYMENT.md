# 🚂 Railway Deployment Guide - Sanad

## دليل شامل لنشر المشروع على Railway

---

## 📋 قبل البدء

### **المتطلبات**
- ✅ حساب GitHub
- ✅ حساب Railway (مجاني)
- ✅ DeepSeek API Key
- ✅ OpenAI API Key
- ✅ المشروع على GitHub

---

## 🎯 الخطوات الكاملة

### **المرحلة 1: تجهيز GitHub Repository**

#### **1.1 إنشاء Repository**
```bash
# إذا لم تكن قد أنشأت repo بعد
git init
git add .
git commit -m "Initial commit: Sanad AI Chat Platform"
git branch -M main
git remote add origin https://github.com/balawi2991/sanadbot.git
git push -u origin main
```

#### **1.2 التحقق من الملفات المهمة**
تأكد من وجود:
- ✅ `server/railway.json`
- ✅ `server/Procfile`
- ✅ `server/.env.example`
- ✅ `.gitignore` (لا يحتوي على .env)

---

### **المرحلة 2: إعداد Railway Project**

#### **2.1 إنشاء حساب Railway**
1. اذهب إلى: https://railway.app
2. سجل دخول بـ GitHub
3. اربط حسابك

#### **2.2 إنشاء مشروع جديد**
1. Dashboard → **"New Project"**
2. اختر **"Deploy from GitHub repo"**
3. اختر `balawi2991/sanadbot`
4. Railway سيبدأ بـ auto-detect

#### **2.3 تكوين Backend Service**

**في Railway Dashboard:**

1. **اذهب إلى Settings**
   - Service Name: `sanad-backend`
   - Root Directory: `server`
   
2. **Build Settings**
   - Build Command: `npm install && npm run build`
   - Start Command: `npm start`
   
3. **Deploy Trigger**
   - Branch: `main`
   - Auto-deploy: ✅ Enabled

---

### **المرحلة 3: إضافة PostgreSQL Database**

#### **3.1 إضافة Database Service**
1. في Project → **"New"** → **"Database"** → **"PostgreSQL"**
2. Railway سينشئ database تلقائياً
3. سيظهر `DATABASE_URL` في Variables

#### **3.2 تثبيت pgvector Extension**

**الطريقة 1: من Railway Dashboard**
```bash
# في Railway Dashboard
# اذهب إلى PostgreSQL service
# اضغط "Connect"
# اختر "psql"

# في psql terminal:
CREATE EXTENSION vector;
\q
```

**الطريقة 2: من Local Machine**
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link to project
railway link

# Connect to database
railway connect postgresql

# في psql:
CREATE EXTENSION vector;
\q
```

---

### **المرحلة 4: تشغيل Database Migrations**

#### **4.1 من Railway CLI**
```bash
# تأكد أنك في مجلد المشروع
cd /path/to/sanadbot

# Run schema
railway run psql $DATABASE_URL < server/src/db/schema.sql

# Run updates
railway run psql $DATABASE_URL < server/src/db/schema-updates.sql
```

#### **4.2 التحقق من النجاح**
```bash
railway connect postgresql

# في psql:
\dt  # عرض الجداول
\q
```

يجب أن ترى:
- ✅ users
- ✅ conversations
- ✅ messages
- ✅ training_materials
- ✅ chunks
- ✅ agents
- ✅ subscription_tiers
- ✅ user_subscriptions
- ✅ daily_usage
- ✅ audit_logs

---

### **المرحلة 5: إضافة Environment Variables**

#### **5.1 في Railway Dashboard**

اذهب إلى Backend Service → **Variables** → **Raw Editor**

```env
# Database (Auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# AI APIs (Required)
DEEPSEEK_API_KEY=sk-your-deepseek-key-here
OPENAI_API_KEY=sk-your-openai-key-here

# Security (Required - Generate strong key)
JWT_SECRET=your-super-secret-jwt-key-min-32-characters-long

# Server Configuration
PORT=3001
NODE_ENV=production

# CORS (Update after frontend deployment)
CORS_ORIGIN=https://your-frontend-url.vercel.app
```

#### **5.2 توليد JWT Secret**
```bash
# في terminal:
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

---

### **المرحلة 6: Deploy Backend**

#### **6.1 Trigger Deployment**
1. Railway سيبدأ deploy تلقائياً
2. راقب Logs في Dashboard
3. انتظر حتى يصبح Status: **"Active"**

#### **6.2 الحصول على Backend URL**
1. في Backend Service → **Settings**
2. اذهب إلى **Networking**
3. اضغط **"Generate Domain"**
4. سيعطيك URL مثل: `sanad-backend.railway.app`

#### **6.3 اختبار Backend**
```bash
# Health check
curl https://sanad-backend.railway.app/health

# يجب أن ترى:
# {"status":"ok","timestamp":"...","uptime":...}
```

---

### **المرحلة 7: Deploy Frontend (Vercel)**

#### **7.1 إنشاء Vercel Project**
1. اذهب إلى: https://vercel.com
2. Import `balawi2991/sanadbot`
3. **Root Directory**: اتركه فارغ (/)

#### **7.2 Environment Variables**
```env
VITE_API_URL=https://sanad-backend.railway.app/api
```

#### **7.3 Deploy**
- Vercel سيبني ويرفع تلقائياً
- سيعطيك URL مثل: `sanadbot.vercel.app`

#### **7.4 تحديث CORS في Railway**
1. ارجع لـ Railway Backend
2. Variables → `CORS_ORIGIN`
3. غيره إلى: `https://sanadbot.vercel.app`
4. Redeploy Backend

---

### **المرحلة 8: إنشاء مستخدم تجريبي**

#### **8.1 الاتصال بـ Database**
```bash
railway connect postgresql
```

#### **8.2 إنشاء User**
```sql
-- إنشاء مستخدم
INSERT INTO users (id, email, name)
VALUES ('test-user-id', 'admin@sanad.com', 'Admin User');

-- إنشاء subscription (Free tier)
INSERT INTO user_subscriptions (user_id, tier_id, status)
SELECT 'test-user-id', id, 'active'
FROM subscription_tiers
WHERE name = 'free';

-- التحقق
SELECT * FROM users;
SELECT * FROM user_subscriptions;
\q
```

---

### **المرحلة 9: إنشاء Agent & API Key**

#### **9.1 الحصول على JWT Token**

**مؤقتاً** (حتى نضيف login):
```javascript
// في browser console على frontend
const jwt = require('jsonwebtoken');
const token = jwt.sign(
  { id: 'test-user-id', email: 'admin@sanad.com' },
  'your-jwt-secret',
  { expiresIn: '7d' }
);
console.log(token);
```

أو استخدم: https://jwt.io

#### **9.2 إنشاء Agent**
```bash
curl -X POST https://sanad-backend.railway.app/api/agents \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "My First Agent"}'
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "...",
    "name": "My First Agent",
    "apiKey": "agent_xxxxxxxxxxxxxxxxx",
    "isActive": true
  }
}
```

**احفظ API Key!** ستحتاجه للـ widget.

---

### **المرحلة 10: رفع مادة تدريبية**

#### **10.1 رفع نص**
```bash
curl -X POST https://sanad-backend.railway.app/api/materials/text \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "text",
    "title": "دليل الاستخدام",
    "content": "مرحباً بك في Sanad! هذا نظام ذكاء اصطناعي متقدم..."
  }'
```

#### **10.2 رفع ملف**
```bash
curl -X POST https://sanad-backend.railway.app/api/materials/upload \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "file=@/path/to/document.pdf" \
  -F "title=دليل المنتج"
```

---

### **المرحلة 11: اختبار Chat**

#### **11.1 إرسال رسالة**
```bash
curl -X POST https://sanad-backend.railway.app/api/chat \
  -H "X-API-Key: agent_xxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "مرحباً، كيف يمكنني استخدام النظام؟"
  }'
```

#### **11.2 من Frontend**
1. افتح `https://sanadbot.vercel.app`
2. اذهب إلى أي صفحة
3. اكتب في Chat Widget
4. يجب أن تحصل على رد من AI

---

## 🔧 إعدادات متقدمة

### **Custom Domain (Railway)**

#### **للـ Backend**
1. Railway Service → Settings → Networking
2. Custom Domain → Add Domain
3. أضف: `api.yourdomain.com`
4. أضف CNAME record في DNS:
   ```
   api.yourdomain.com → sanad-backend.railway.app
   ```

#### **للـ Frontend (Vercel)**
1. Vercel Project → Settings → Domains
2. Add Domain: `yourdomain.com`
3. اتبع تعليمات DNS

### **File Storage (Railway Volumes)**

إذا كنت تريد persistent storage:

1. Railway Service → Settings → Volumes
2. Add Volume:
   - Mount Path: `/app/uploads`
   - Size: 1GB (أو حسب الحاجة)

### **Redis for Rate Limiting**

1. Railway → New → Database → Redis
2. أضف `REDIS_URL` في Variables
3. حدّث rate limiter في `server/src/middleware/rateLimiter.ts`

---

## 📊 Monitoring & Logs

### **عرض Logs**
```bash
# من Railway CLI
railway logs

# أو من Dashboard
# Service → Logs tab
```

### **Metrics**
- Railway Dashboard → Service → Metrics
- CPU, Memory, Network usage

---

## 🐛 حل المشاكل

### **Problem: Build Failed**
```bash
# Check logs
railway logs

# Common issues:
# 1. Missing dependencies → npm install
# 2. TypeScript errors → npm run build locally first
# 3. Wrong root directory → Check Settings
```

### **Problem: Database Connection Failed**
```bash
# Verify DATABASE_URL
railway variables

# Test connection
railway connect postgresql
```

### **Problem: pgvector Extension Missing**
```bash
railway connect postgresql
CREATE EXTENSION vector;
\q
```

### **Problem: CORS Error**
```bash
# Update CORS_ORIGIN in Railway
# Must match frontend URL exactly
CORS_ORIGIN=https://sanadbot.vercel.app
```

### **Problem: API Keys Not Working**
```sql
-- Check agents table
railway connect postgresql
SELECT * FROM agents;

-- Verify API key format
-- Should start with: agent_
```

---

## ✅ Checklist النهائي

### **Backend**
- [ ] Railway project created
- [ ] PostgreSQL added
- [ ] pgvector installed
- [ ] Migrations run successfully
- [ ] Environment variables set
- [ ] Backend deployed (Status: Active)
- [ ] Health check passing
- [ ] Domain generated

### **Database**
- [ ] All tables created
- [ ] Test user created
- [ ] Subscription created
- [ ] Agent created
- [ ] API key generated

### **Frontend**
- [ ] Vercel project created
- [ ] VITE_API_URL set
- [ ] Deployed successfully
- [ ] Can access website

### **Testing**
- [ ] Material uploaded
- [ ] Chat message sent
- [ ] Response received
- [ ] Conversation saved
- [ ] User isolation verified

---

## 🎯 Next Steps

بعد Deployment الناجح:

1. **إضافة User Registration**
   - Login/Signup pages
   - Password hashing
   - Email verification

2. **تحسين Upload UI**
   - Drag & drop
   - Progress bars
   - Material management

3. **Analytics Dashboard**
   - Usage statistics
   - Popular questions
   - Response times

4. **Custom Domain**
   - Professional domain
   - SSL certificate
   - CDN setup

---

## 📞 الدعم

### **Railway Issues**
- 📖 Docs: https://docs.railway.app
- 💬 Discord: https://discord.gg/railway
- 🐛 GitHub: https://github.com/railwayapp/railway

### **Project Issues**
- 🐛 GitHub Issues: https://github.com/balawi2991/sanadbot/issues

---

## 🎉 تهانينا!

إذا وصلت هنا، مشروعك الآن **Live on Production!** 🚀

**URL Backend**: `https://sanad-backend.railway.app`
**URL Frontend**: `https://sanadbot.vercel.app`

---

**الوقت المتوقع للـ Deployment**: 30-45 دقيقة

**الحالة**: 🟢 **Ready for Production!**
