# 🚂 Railway Deployment Guide - Sanad (MintChat)

## 📋 Overview

هذا الدليل يشرح كيفية نشر Sanad على Railway مع:
- ✅ Backend + Frontend في service واحد
- ✅ PostgreSQL database على Railway
- ✅ Environment variables آمنة
- ✅ Auto-deploy من GitHub

---

## 🎯 Architecture

```
Railway Project: Sanad
├── Service 1: Web App (Backend + Frontend)
│   ├── Port 3001
│   ├── Serves API at /api/*
│   └── Serves Frontend at /*
└── Service 2: PostgreSQL (Railway Plugin)
    └── Automatic connection string
```

---

## 📝 Pre-requisites

1. ✅ حساب على [Railway](https://railway.app)
2. ✅ حساب GitHub
3. ✅ DeepSeek API Key
4. ✅ OpenAI API Key
5. ✅ المشروع على GitHub repository

---

## 🚀 Deployment Steps

### **Step 1: Push to GitHub**

```bash
# Initialize git (if not done)
git init
git add .
git commit -m "Initial commit - Ready for Railway"

# Create GitHub repo and push
git remote add origin https://github.com/YOUR_USERNAME/sanad.git
git branch -M main
git push -u origin main
```

### **Step 2: Create Railway Project**

1. اذهب إلى [Railway Dashboard](https://railway.app/dashboard)
2. اضغط **"New Project"**
3. اختر **"Deploy from GitHub repo"**
4. اختر repository: `sanad`
5. Railway سيكتشف تلقائياً أنه Node.js project

### **Step 3: Add PostgreSQL**

1. في Railway project، اضغط **"+ New"**
2. اختر **"Database"**
3. اختر **"PostgreSQL"**
4. Railway سينشئ database تلقائياً
5. سيتم إنشاء `DATABASE_URL` تلقائياً

### **Step 4: Configure Environment Variables**

في Railway project settings، أضف المتغيرات التالية:

#### **Required Variables:**

```env
# Node Environment
NODE_ENV=production

# JWT Secret (Generate a strong random string)
JWT_SECRET=your-super-secret-jwt-key-min-32-characters-long
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_EXPIRES_IN=30d

# DeepSeek API
DEEPSEEK_API_KEY=sk-your-deepseek-api-key
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat
DEEPSEEK_TEMPERATURE=0.7
DEEPSEEK_MAX_TOKENS=1000
DEEPSEEK_TIMEOUT=30000

# OpenAI API (for embeddings)
OPENAI_API_KEY=sk-your-openai-api-key

# Database (Auto-generated by Railway)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# CORS (Railway provides this automatically)
CORS_ORIGIN=https://your-app.up.railway.app

# Rate Limiting
RATE_LIMIT_PER_MINUTE=10
RATE_LIMIT_PER_HOUR=100
RATE_LIMIT_PER_DAY=500

# RAG Configuration
RAG_CHUNK_SIZE=750
RAG_CHUNK_OVERLAP=100
RAG_TOP_K=10
RAG_RERANK_TOP=3
RAG_SIMILARITY_THRESHOLD=0.7
```

#### **كيفية توليد JWT_SECRET:**

```bash
# في terminal
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### **Step 5: Configure Build Settings**

Railway سيكتشف تلقائياً من `railway.json`:

```json
{
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm run build:all"
  },
  "deploy": {
    "startCommand": "npm start",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### **Step 6: Setup Database Schema**

بعد deployment، قم بتشغيل schema:

#### **Option A: من Railway CLI**

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link to project
railway link

# Run schema
railway run psql $DATABASE_URL < server/src/db/schema.sql
```

#### **Option B: من Railway Dashboard**

1. اذهب إلى PostgreSQL service
2. اضغط **"Connect"**
3. اختر **"psql"**
4. انسخ schema.sql content والصقه

### **Step 7: Deploy!**

1. Railway سيبدأ build تلقائياً
2. انتظر حتى ينتهي build (~3-5 دقائق)
3. Railway سيعطيك URL: `https://your-app.up.railway.app`

---

## 🔧 Post-Deployment

### **1. Test Health Endpoint**

```bash
curl https://your-app.up.railway.app/health
```

يجب أن ترى:
```json
{
  "status": "ok",
  "timestamp": "...",
  "uptime": 123
}
```

### **2. Test Frontend**

افتح `https://your-app.up.railway.app` في المتصفح

### **3. Create First User**

```bash
curl -X POST https://your-app.up.railway.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "name": "Admin",
    "password": "YourSecurePassword123!"
  }'
```

### **4. Add Training Material**

```bash
# Login first to get token
TOKEN="your-access-token-from-login"

curl -X POST https://your-app.up.railway.app/api/materials \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "type": "text",
    "title": "Welcome Guide",
    "content": "Welcome to Sanad! This is your AI assistant..."
  }'
```

---

## 📊 Monitoring

### **Railway Dashboard**

- **Metrics**: CPU, Memory, Network
- **Logs**: Real-time logs
- **Deployments**: History of all deployments

### **Custom Monitoring**

```bash
# View logs
railway logs

# Follow logs
railway logs --follow
```

---

## 🔄 Updates & Redeployment

### **Auto-Deploy (Recommended)**

Railway auto-deploys عند push إلى GitHub:

```bash
git add .
git commit -m "Update feature"
git push origin main
# Railway will auto-deploy
```

### **Manual Deploy**

```bash
railway up
```

---

## 💰 Cost Estimation

### **Hobby Plan (Free)**
- ✅ $5 free credits/month
- ✅ Good for testing
- ⚠️ Limited resources

### **Developer Plan ($20/month)**
- ✅ $20 credits included
- ✅ Better performance
- ✅ More resources

### **Estimated Monthly Cost:**
- **Web Service**: ~$5-10
- **PostgreSQL**: ~$5
- **Total**: ~$10-15/month

---

## 🐛 Troubleshooting

### **Build Fails**

```bash
# Check logs
railway logs

# Common issues:
# 1. Missing dependencies
npm install

# 2. TypeScript errors
npm run typecheck

# 3. Build command fails
npm run build:all
```

### **Database Connection Error**

```bash
# Verify DATABASE_URL
railway variables

# Test connection
railway run psql $DATABASE_URL -c "SELECT 1"
```

### **CORS Error**

تأكد من `CORS_ORIGIN` في environment variables:
```env
CORS_ORIGIN=https://your-app.up.railway.app
```

### **API Keys Invalid**

تحقق من:
1. ✅ DEEPSEEK_API_KEY صحيح
2. ✅ OPENAI_API_KEY صحيح
3. ✅ API keys لها credits كافية

---

## 🔒 Security Checklist

- [ ] JWT_SECRET قوي وعشوائي (32+ characters)
- [ ] API keys في environment variables فقط
- [ ] CORS_ORIGIN محدد بدقة
- [ ] Rate limiting مفعّل
- [ ] Helmet middleware مفعّل
- [ ] HTTPS only (Railway يوفره تلقائياً)
- [ ] Database backups مفعّلة

---

## 📚 Useful Commands

```bash
# Railway CLI
railway login              # Login to Railway
railway link               # Link to project
railway status             # Check status
railway logs               # View logs
railway logs --follow      # Follow logs
railway variables          # List env vars
railway run <command>      # Run command in Railway
railway open               # Open in browser

# Database
railway run psql $DATABASE_URL                    # Connect to DB
railway run psql $DATABASE_URL -c "SELECT 1"     # Run query
railway run psql $DATABASE_URL < schema.sql      # Run schema
```

---

## 🎯 Next Steps

1. ✅ Setup custom domain
2. ✅ Configure email notifications
3. ✅ Setup monitoring alerts
4. ✅ Configure backups
5. ✅ Add CI/CD tests

---

## 📞 Support

- **Railway Docs**: https://docs.railway.app
- **Railway Discord**: https://discord.gg/railway
- **Railway Status**: https://status.railway.app

---

## ✅ Deployment Checklist

- [ ] Code pushed to GitHub
- [ ] Railway project created
- [ ] PostgreSQL added
- [ ] Environment variables configured
- [ ] Database schema applied
- [ ] Health endpoint working
- [ ] Frontend accessible
- [ ] First user created
- [ ] Training material added
- [ ] Chat widget working
- [ ] Monitoring setup

---

**🎉 Congratulations! Your Sanad app is now live on Railway!**

**URL**: `https://your-app.up.railway.app`
